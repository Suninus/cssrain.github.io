<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>最近一周的工作</title>
    <link rel="stylesheet" type="text/css" href="../bootstrap/css/bootstrap.min.css">
    <style>
    #loggedout {
        text-align: center;
        font-size: 20px;
        padding-top: 50px;
    }
    #loggedin { 
        display: none; 
    }
    #output {
        padding: 4px;
    }
    </style>
</head>
<body> 

<div class="container">
<div class="row">
    <div class="col-md-12">
        <div id="loggedout" class="text-center pd">
            <a href="javascript:;" class="btn btn-primary" role="button" id="connectLink">连接到Trello</a>
        </div>
    </div>
    <div class="col-md-12">
        <div id="loggedin">
            <div id="header">
                当前用户：<span id="fullName"></span> 
                <a id="disconnect" href="#">退出</a>
            </div>
            
            <h3>本周已完成的工作：</h3>
            <div id="outputDone"></div>
            <h3>本周正在做的工作：</h3>
            <div id="outputDoing"></div>

        </div>    
    </div>
</div>
    
</div>

<script type="text/javascript" src="res/lib/jquery/1.7.2/jquery.js"></script>
<script src="https://api.trello.com/1/client.js?key=93a14c35871c5f65fbbfd419367b6606"></script>
<script>
var updateLoggedIn = function() {
    var isLoggedIn = Trello.authorized();
    $("#loggedout").toggle(!isLoggedIn);
    $("#loggedin").toggle(isLoggedIn);        
};
    
var logout = function() {
    Trello.deauthorize();
    updateLoggedIn();
};

//登录
$("#connectLink").click(function(){
    AuthenticateTrello();
}).trigger("click");
//退出
$("#disconnect").click(logout);
//登录
function AuthenticateTrello() {
    Trello.authorize({
        name: "最近一周的工作",
        type: "popup",
        interactive: true,
        expiration: "never",
        scope: { write: true, read: true },
        success: function () { onAuthorizeSuccessful(); },
        error: function () { onFailedAuthorization(); }
    });
}
//成功
function onAuthorizeSuccessful() {
    var token = Trello.token();
    updateLoggedIn();
    $("#output").empty();
    Trello.members.get("me", function(member){
        $("#fullName").text(member.fullName);
        var $cards = $("<div>")
            .text("正在加载您的最近一周的工作...")
            .appendTo("#output");

               Trello.get("members/me/cards",{filter:'open',since:"2014-7-11 00:00:00" ,cards:"open", board_lists :"open", before : "2014-7-16 23:59:59",actions:"updateCard:idList"},  function(cards) {
                      console.log(cards);
                      for(var m=0;m<cards.length;m++){
                            Trello.get("cards/"+cards[m].id,{filter:'open',board:true,list:true,actions:"updateCard:idList"},  function(cards) {
                                if(cards.list.name=="Done"){
                                    $("#outputDone").append("<p><strong>"+cards.board.name +"</strong>："+cards.name+"</p>");
                                }
                                if(cards.list.name=="Doing"){
                                    $("#outputDoing").append("<p><strong>"+cards.board.name +"</strong>："+cards.name+"</p>");
                                }
                            },function(cards) {
                                alert('加载数据出了点小问题，请重试！');
                            })
                      }             

               });


               /*
              Trello.get("members/me",{actions:'updateCard:idList', cards : "open" , boards :"organization" , board_lists:"open" , since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59"}, function(cards) {
                    console.log(cards);
                        for(var m=0;m<cards.boards.length;m++){
                           Trello.get("members/me/cards",{filter:'open',since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59",actions:"updateCard:idList"},  function(cards) {
                                 console.log("具体任务：");
                                 console.log(cards);

                           });
                        }
               });
               return;

               //拉取所有人的记录
               Trello.get("boards/"+cards.boards[m].id+"/lists/open",{cards:"open"},  function(cards) {
                     console.log("具体任务：");
                     console.log(cards);

               });



               Trello.get("members/me",{actions:'updateCard:idList', cards : "open" , boards :"organization" , board_lists:"open" , since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59"}, function(cards) {
                    console.log(cards);
               });
               return;
           

            Trello.get("members/me/boards",{filter:'open',since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59"}, function(cards) {
                console.log("board：");
                console.log(cards);
                for(var j=0;j<cards.length;j++){
                   Trello.get("boards/"+cards[j].id+"/lists",{cards:'open',since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59"}, function(cards) {
                         console.log("listid：");
                         console.log(cards);
                        for(var m=0;m<cards.length;m++){
                           Trello.get("lists/"+cards[m].id+"/cards",{actions:'updateCard:idList', members : true,since:"2014-7-11 00:00:00" , before : "2014-7-16 23:59:59"}, function(cards) {
                                 console.log("具体任务：");
                                 console.log(cards);

                           });
                        }

                   });
                }
               
            });
           */
    });
}


               function showHtml(arrJson){
                    var txtDonehtml = "<h4>您本周已完成的工作如下：</h4>";
                    var txtDoinghtml = "<h4>您本周正在做的工作如下：</h4>";
                    console.log(arrJson.done.length)
                    for(var i=0;i<arrJson.done.length;i++){
                        txtDonehtml += "<p>"+arrJson.done[i]+"</p>";
                    }
                    for(var i=0;i<arrJson.doing.length;i++){
                        txtDoinghtml += "<p>"+arrJson.doing[i]+"</p>";
                    }
                    $("#output").html(txtDonehtml +""+ txtDoinghtml);
                }
//失败
function onFailedAuthorization() {
    alert("登录失败!");
}

/*
filter类别:
    addAttachmentToCard 添加附件
    addChecklistToCard 添加checklist
    addMemberToBoard 添加人员
    addMemberToCard 添加人员
    addMemberToOrganization 添加人员
    addToOrganizationBoard  添加人员
    commentCard  回复
    copyCommentCard 复制回复
    convertToCardFromCheckItem 转换checklist到cart
    copyBoard 复制board
    createBoard 新建board
    createCard 新建card
    copyCard 复制card
    createList 创建list
    createOrganization 创建组织
    deleteAttachmentFromCard 删除附件
    deleteBoardInvitation 删除board
    deleteCard 删除card
    deleteOrganizationInvitation 删除组织
    disablePowerUp 禁用powerup
    emailCard 邮件card
    enablePowerUp 启用powerup
    makeAdminOfBoard  设置管理员
    makeNormalMemberOfBoard  设置普通人员
    makeNormalMemberOfOrganization  设置人员
    makeObserverOfBoard  设置观察者
    memberJoinedTrello  人员加入
    moveCardFromBoard  移动card   ##########
    moveListFromBoard   移动list 
    moveCardToBoard  移动card   ##############
    moveListToBoard 移动list
    removeAdminFromBoard  移除管理员
    removeAdminFromOrganization  移除管理员
    removeChecklistFromCard  移除checklist
    removeFromOrganizationBoard  移除
    removeMemberFromCard  移除人员
    unconfirmedBoardInvitation    不确认的邀请
    unconfirmedOrganizationInvitation   不确认的组织
    updateBoard   更新board
    updateCard  更新card  （下面有分类）
    updateCheckItemStateOnCard  更新checklist状态     ######################
    updateChecklist  更新checklist              ###############
    updateList  更新list
    updateMember   更新人员
    updateOrganization 更新组织
    updateCard:idList  更新：idList  （使用这个即可）#############
    updateCard:closed  更新：close
    updateCard:desc  更新：详细
    updateCard:name  更新：名称
    updateList:closed   更新list
    updateList:name  更新list：name
*/
</script>

</div>
</body>
</html>
